<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Editar Licencia</title>
  <link rel="stylesheet" th:href="@{/css/styles.css}" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>
</head>

<body class="admin-body">
  <!-- Layout principal con sidebar y contenido -->
  <div class="admin-layout">
    <!-- Sidebar -->
    <div th:replace="~{sidebar/sidebar :: sidebar}"></div>

    <!-- Contenido principal -->
    <div class="main-content">
      <!-- Header -->
      <header class="page-header">
        <div class="container-fluid">
          <div class="row align-items-center">
            <div class="col">
              <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                  <li class="breadcrumb-item">
                    <a th:href="@{/admin}" class="text-decoration-none">
                      <i class="fas fa-home"></i> Inicio
                    </a>
                  </li>
                  <li class="breadcrumb-item">
                    <a th:href="@{/admin/licencias}" class="text-decoration-none">
                      <i class="fas fa-id-card"></i> Licencias
                    </a>
                  </li>
                  <li class="breadcrumb-item active" aria-current="page">
                    <i class="fas fa-edit"></i> Editar Licencia
                  </li>
                </ol>
              </nav>
              <h1 class="page-title mt-2">
                <i class="fas fa-edit me-3"></i>Editar Licencia
              </h1>
            </div>
            <div class="col-auto">
              <a th:href="@{/admin/licencias}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Volver a Licencias
              </a>
            </div>
          </div>
        </div>
      </header>

      <!-- Alertas -->
      <div class="container-fluid mt-4">
        <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
          <i class="fas fa-check-circle me-2"></i>
          <span th:text="${success}"></span>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
          <i class="fas fa-exclamation-circle me-2"></i>
          <span th:text="${error}"></span>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      </div>

      <!-- Contenido principal -->
      <main class="page-content">
        <div class="container-fluid">
          <div class="row justify-content-center">
            <div class="col-lg-8">
              <!-- Tarjeta de formulario -->
              <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                  <h5 class="card-title mb-0">
                    <i class="fas fa-id-card me-2"></i>Información de la Licencia
                    <span class="badge bg-light text-dark ms-2"
                      th:text="${licencia.id != null} ? 'ID: ' + ${licencia.id} : 'Nueva'">
                      ID: 1
                    </span>
                  </h5>
                </div>
                <div class="card-body">
                  <form th:action="@{/admin/licencias/edit/{id}(id=${licencia.id})}" method="post"
                    id="editLicenciaForm">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <input type="hidden" name="_method" value="put" />

                    <!-- Campo ID (solo lectura) -->
                    <div class="row mb-3">
                      <div class="col-md-2">
                        <label for="id" class="form-label">ID</label>
                        <input type="text" class="form-control bg-light" id="id" th:value="${licencia.id}" readonly>
                      </div>
                      <div class="col-md-10">
                        <label for="nombre" class="form-label">Nombre de la Licencia <span
                            class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="nombre" name="nombre" th:value="${licencia.nombre}"
                          required placeholder="Ej: Básica, Premium, Empresarial">
                        <div class="form-text">Nombre descriptivo de la licencia</div>
                      </div>
                    </div>

                    <!-- Límite de Animales y Costo -->
                    <div class="row mb-3">
                      <div class="col-md-6">
                        <label for="limiteAnimales" class="form-label">Límite de Animales <span
                            class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="limiteAnimales" name="limiteAnimales"
                          th:value="${licencia.limiteAnimales}" required min="1" max="1000">
                        <div class="form-text">Número máximo de animales permitidos</div>
                      </div>
                      <div class="col-md-6">
                        <label for="costo" class="form-label">Costo Mensual <span class="text-danger">*</span></label>
                        <div class="input-group">
                          <span class="input-group-text">$</span>
                          <input type="number" class="form-control" id="costo" name="costo"
                            th:value="${licencia.costo != null} ? ${licencia.costo} : '50.00'" required min="0"
                            step="0.01">
                          <span class="input-group-text">.00</span>
                        </div>
                        <div class="form-text">Costo mensual en dólares</div>
                      </div>
                    </div>

                    <!-- Fechas -->
                    <div class="row mb-3">
                      <div class="col-md-6">
                        <label for="fechaInicio" class="form-label">Fecha de Inicio <span
                            class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="fechaInicio" name="fechaInicio"
                          th:value="${licencia.fechaInicio != null} ? ${licencia.fechaInicio} : ''" required>
                        <div class="form-text">Fecha de inicio de la licencia</div>
                      </div>
                      <div class="col-md-6">
                        <label for="fechaFinal" class="form-label">Fecha de Finalización <span
                            class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="fechaFinal" name="fechaFinal"
                          th:value="${licencia.fechaFinal != null} ? ${licencia.fechaFinal} : ''" required>
                        <div class="form-text">Fecha de finalización de la licencia</div>
                      </div>
                    </div>

                    <!-- Estado y Duración -->
                    <div class="row mb-4">
                      <div class="col-md-6">
                        <label class="form-label">Estado Actual</label>
                        <div class="d-flex align-items-center">
                          <div class="text-muted small">
                            <i class="fas fa-info-circle me-1"></i>
                            <!-- Caso 1: Fecha final es null -->
                            <span th:if="${licencia.fechaFinal == null}" class="text-warning">
                              <i class="fas fa-clock me-1"></i>Sin fecha de expiración
                            </span>

                            <!-- Caso 2: Fecha final está en el pasado (expirada) -->
                            <span
                              th:if="${licencia.fechaFinal != null && licencia.fechaFinal.isBefore(T(java.time.LocalDate).now())}"
                              class="text-danger">
                              <i class="fas fa-exclamation-triangle me-1"></i>La licencia ha expirado
                              <small
                                th:text="'(' + ${#temporals.format(licencia.fechaFinal, 'dd/MM/yyyy')} + ')'"></small>
                            </span>

                            <!-- Caso 3: Fecha final está en el futuro (vigente) -->
                            <span
                              th:if="${licencia.fechaFinal != null && !licencia.fechaFinal.isBefore(T(java.time.LocalDate).now())}"
                              class="text-success">
                              <i class="fas fa-check-circle me-1"></i>Licencia vigente
                              <small
                                th:text="' (Expira: ' + ${#temporals.format(licencia.fechaFinal, 'dd/MM/yyyy')} + ')'"></small>
                            </span>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Duración</label>
                        <div class="alert alert-info py-2">
                          <i class="fas fa-calendar-alt me-2"></i>
                          <span th:if="${licencia.fechaInicio != null && licencia.fechaFinal != null}">
                            <th:block
                              th:with="totalDias=${T(java.time.temporal.ChronoUnit).DAYS.between(licencia.fechaInicio, licencia.fechaFinal)}">
                              <strong th:text="${totalDias}">365</strong> días
                            </th:block>
                            (<span th:text="${#temporals.format(licencia.fechaInicio, 'dd/MM/yyyy')}">01/01/2024</span>
                            -
                            <span th:text="${#temporals.format(licencia.fechaFinal, 'dd/MM/yyyy')}">31/12/2024</span>)
                          </span>
                          <span th:unless="${licencia.fechaInicio != null && licencia.fechaFinal != null}">
                            Duración no definida
                          </span>
                        </div>
                      </div>
                    </div>

                    <!-- Botones de acción -->
                    <div class="d-flex justify-content-between align-items-center border-top pt-4">
                      <div>
                        <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal"
                          data-bs-target="#deleteModal">
                          <i class="fas fa-trash me-2"></i>Eliminar Licencia
                        </button>
                      </div>
                      <div>
                        <a th:href="@{/admin/licencias}" class="btn btn-secondary me-2">
                          <i class="fas fa-times me-2"></i>Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary">
                          <i class="fas fa-save me-2"></i>Guardar Cambios
                        </button>
                      </div>
                    </div>
                  </form>
                </div>
              </div>

              <!-- Información de auditoría -->
              <div class="card shadow-sm mt-4">
                <div class="card-header bg-light">
                  <h6 class="card-title mb-0">
                    <i class="fas fa-history me-2"></i>Información de Auditoría
                  </h6>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6">
                      <div>
                        <small class="text-muted">Fecha de creación:</small>
                        <div class="d-flex align-items-center">
                          <i class="far fa-calendar-plus me-2 text-primary"></i>
                          <span
                            th:text="${licencia.fechaCreacion != null} ? ${#temporals.format(licencia.fechaCreacion, 'dd/MM/yyyy HH:mm')} : 'N/A'">
                            01/01/2024 10:30
                          </span>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div>
                        <small class="text-muted">Última modificación:</small>
                        <div class="d-flex align-items-center">
                          <i class="far fa-calendar-check me-2 text-warning"></i>
                          <span
                            th:text="${licencia.fechaModificacion != null} ? ${#temporals.format(licencia.fechaModificacion, 'dd/MM/yyyy HH:mm')} : 'N/A'">
                            15/01/2024 14:45
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>

    </div>
  </div>

  <!-- Footer -->
  <footer class="page-footer">
    <div class="container-fluid">
      <p class="mb-0">&copy; 2025 Our Application. Todos los derechos reservados.</p>
    </div>
  </footer>

  <!-- Modal de confirmación para eliminar -->
  <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="deleteModalLabel">
            <i class="fas fa-exclamation-triangle me-2"></i>Confirmar Eliminación
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-circle me-2"></i>
            <strong>¡Advertencia!</strong> Esta acción no se puede deshacer.
          </div>
          <p>¿Está seguro de que desea eliminar la licencia <strong th:text="${licencia.nombre}">Básica</strong>?</p>
          <div class="alert alert-danger small">
            <i class="fas fa-users me-2"></i>
            <strong>Impacto:</strong> Esta acción afectará a todos los usuarios que tengan asignada esta licencia.
            Se recomienda reasignar a los usuarios a otra licencia antes de eliminar.
          </div>
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="confirmDelete">
            <label class="form-check-label" for="confirmDelete">
              Confirmo que entiendo las consecuencias y deseo proceder
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <form th:action="@{/admin/licencias/delete/{id}(id=${licencia.id})}" method="post" style="display: inline;">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <input type="hidden" name="_method" value="delete" />
            <button type="submit" id="confirmDeleteBtn" class="btn btn-danger" disabled>
              <i class="fas fa-trash me-1"></i>Eliminar Permanentemente
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Validación de fechas
      const fechaInicioInput = document.getElementById('fechaInicio');
      const fechaFinalInput = document.getElementById('fechaFinal');
      const form = document.getElementById('editLicenciaForm');

      // Configurar fecha mínima para fecha final
      if (fechaInicioInput && fechaFinalInput) {
        fechaInicioInput.addEventListener('change', function () {
          fechaFinalInput.min = this.value;

          // Si fecha final es anterior a la nueva fecha inicio, actualizarla
          if (fechaFinalInput.value && fechaFinalInput.value < this.value) {
            fechaFinalInput.value = this.value;
          }
        });

        // Inicializar el mínimo de fecha final
        if (fechaInicioInput.value) {
          fechaFinalInput.min = fechaInicioInput.value;
        }
      }

      // Validación del formulario
      if (form) {
        form.addEventListener('submit', function (e) {
          const nombre = document.getElementById('nombre').value.trim();
          const limiteAnimales = document.getElementById('limiteAnimales').value;
          const costo = document.getElementById('costo').value;
          const fechaInicio = fechaInicioInput.value;
          const fechaFinal = fechaFinalInput.value;

          let isValid = true;
          let errorMessage = '';

          // Validaciones
          if (!nombre) {
            isValid = false;
            errorMessage = 'El nombre de la licencia es requerido';
          } else if (!limiteAnimales || limiteAnimales < 1) {
            isValid = false;
            errorMessage = 'El límite de animales debe ser mayor a 0';
          } else if (!costo || costo < 0) {
            isValid = false;
            errorMessage = 'El costo debe ser un valor positivo';
          } else if (!fechaInicio) {
            isValid = false;
            errorMessage = 'La fecha de inicio es requerida';
          } else if (!fechaFinal) {
            isValid = false;
            errorMessage = 'La fecha de finalización es requerida';
          } else if (fechaFinal <= fechaInicio) {
            isValid = false;
            errorMessage = 'La fecha final debe ser posterior a la fecha de inicio';
          }

          if (!isValid) {
            e.preventDefault();
            alert('Error: ' + errorMessage);
          } else {
            // Cambiar texto del botón mientras se procesa
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Guardando...';
          }
        });
      }

      // Confirmación de eliminación
      const confirmDeleteCheckbox = document.getElementById('confirmDelete');
      const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

      if (confirmDeleteCheckbox && confirmDeleteBtn) {
        confirmDeleteCheckbox.addEventListener('change', function () {
          confirmDeleteBtn.disabled = !this.checked;
        });
      }

      // Mostrar advertencia si se intenta salir sin guardar
      let formChanged = false;
      const formInputs = document.querySelectorAll('#editLicenciaForm input, #editLicenciaForm textarea, #editLicenciaForm select');

      formInputs.forEach(input => {
        input.addEventListener('change', function () {
          formChanged = true;
        });

        input.addEventListener('input', function () {
          formChanged = true;
        });
      });

      window.addEventListener('beforeunload', function (e) {
        if (formChanged) {
          e.preventDefault();
          e.returnValue = 'Tienes cambios sin guardar. ¿Seguro que quieres salir?';
          return e.returnValue;
        }
      });

      // Prevenir el cierre del modal de eliminación al hacer clic fuera
      const deleteModal = document.getElementById('deleteModal');
      if (deleteModal) {
        deleteModal.addEventListener('show.bs.modal', function () {
          const modalInstance = bootstrap.Modal.getInstance(deleteModal);
          if (modalInstance) {
            modalInstance._config.backdrop = 'static';
            modalInstance._config.keyboard = false;
          }
        });
      }
    });
  </script>

  <style>
    .card {
      border: none;
      border-radius: 10px;
    }

    .card-header {
      border-radius: 10px 10px 0 0 !important;
    }

    .form-control:focus,
    .form-select:focus {
      border-color: #86b7fe;
      box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }

    .input-group-text {
      background-color: #f8f9fa;
      border-color: #dee2e6;
    }

    .badge {
      font-size: 0.85em;
      padding: 0.4em 0.8em;
    }

    .form-check-input:checked {
      background-color: #198754;
      border-color: #198754;
    }

    .form-check-input:focus {
      border-color: #86b7fe;
      box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }

    .alert-info {
      background-color: #d1ecf1;
      border-color: #bee5eb;
      color: #0c5460;
    }

    .breadcrumb {
      background-color: transparent;
      padding: 0;
    }

    .breadcrumb-item.active {
      color: #6c757d;
    }

    .page-title {
      color: #2c3e50;
      font-weight: 600;
    }

    .border-top {
      border-top: 1px solid #dee2e6 !important;
    }

    .text-muted small {
      font-size: 0.85em;
    }
  </style>
</body>

</html>
