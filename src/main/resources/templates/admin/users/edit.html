<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Editar Usuario</title>
  <link rel="stylesheet" th:href="@{/css/styles.css}" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body class="admin-body">
  <!-- Layout principal con sidebar y contenido -->
  <div class="admin-layout">
    <!-- Sidebar -->
    <div th:replace="~{sidebar/sidebar :: sidebar}"></div>

    <!-- Contenido principal -->
    <div class="main-content">
      <!-- Header -->
      <header class="page-header">
        <div class="container-fluid">
          <div class="row align-items-center">
            <div class="col">
              <h1 class="page-title">
                <i class="fas fa-user-edit me-3"></i>Editar Usuario
              </h1>
              <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                  <li class="breadcrumb-item"><a th:href="@{/admin/users}">Usuarios</a></li>
                  <li class="breadcrumb-item active" aria-current="page">Editar</li>
                </ol>
              </nav>
            </div>
            <div class="col-auto">
              <a th:href="@{/admin/users}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Volver
              </a>
            </div>
          </div>
        </div>
      </header>

      <!-- Alertas -->
      <div class="container-fluid mt-4">
        <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
          <i class="fas fa-check-circle me-2"></i>
          <span th:text="${success}"></span>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
          <i class="fas fa-exclamation-circle me-2"></i>
          <span th:text="${error}"></span>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      </div>

      <!-- Contenido principal -->
      <main class="page-content">
        <div class="container-fluid">
          <div class="row justify-content-center">
            <div class="col-lg-8">
              <!-- Tarjeta de formulario -->
              <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                  <h5 class="card-title mb-0">
                    <i class="fas fa-edit me-2"></i>Información del Usuario
                  </h5>
                </div>
                <div class="card-body">
                  <form th:action="@{/admin/users/edit/} + ${user.id}" method="post">
                    <!-- ID del usuario (oculto) -->
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <input type="hidden" name="_method" value="put" />

                    <!-- Información Personal -->
                    <div class="mb-4">
                      <h6 class="text-primary mb-3">
                        <i class="fas fa-user me-2"></i>Información Personal
                      </h6>
                      <div class="row">
                        <div class="col-md-6 mb-3">
                          <label for="nombre" class="form-label">
                            Nombre completo <span class="text-danger">*</span>
                          </label>
                          <input type="text" class="form-control" id="nombre" name="nombre" th:value="${user.nombre}"
                            required placeholder="Ingrese el nombre completo">
                          <div class="invalid-feedback">
                            Por favor ingrese el nombre completo.
                          </div>
                        </div>
                        <div class="col-md-6 mb-3">
                          <label for="nombreUsuario" class="form-label">
                            Nombre de usuario <span class="text-danger">*</span>
                          </label>
                          <input type="text" class="form-control" id="nombreUsuario" name="nombreUsuario"
                            th:value="${user.nombreUsuario}" required placeholder="Ingrese el nombre de usuario">
                          <div class="invalid-feedback">
                            Por favor ingrese el nombre de usuario.
                          </div>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-md-12 mb-3">
                          <label for="correo" class="form-label">
                            Correo electrónico
                          </label>
                          <input type="email" class="form-control" id="correo" name="correo" th:value="${user.correo}"
                            placeholder="usuario@ejemplo.com">
                          <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Correo electrónico para notificaciones
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Seguridad -->
                    <div class="mb-4">
                      <h6 class="text-primary mb-3">
                        <i class="fas fa-lock me-2"></i>Seguridad
                      </h6>
                      <div class="row">
                        <div class="col-md-6 mb-3">
                          <label for="contraseña" class="form-label">
                            Nueva Contraseña
                          </label>
                          <div class="input-group">
                            <input type="password" class="form-control" id="contraseña" name="contraseña"
                              placeholder="Dejar en blanco para mantener actual">
                            <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                              <i class="fas fa-eye"></i>
                            </button>
                          </div>
                          <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Deje en blanco si no desea cambiar la contraseña
                          </div>
                        </div>
                        <div class="col-md-6 mb-3">
                          <label for="confirmarContraseña" class="form-label">
                            Confirmar Contraseña
                          </label>
                          <input type="password" class="form-control" id="confirmarContraseña"
                            name="confirmarContraseña" placeholder="Confirme la nueva contraseña">
                          <div class="invalid-feedback" id="passwordMismatch">
                            Las contraseñas no coinciden.
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Permisos -->
                    <div class="mb-4">
                      <h6 class="text-primary mb-3">
                        <i class="fas fa-shield-alt me-2"></i>Permisos y Rol
                      </h6>
                      <div class="row">
                        <div class="col-md-6 mb-3">
                          <label for="rol" class="form-label">
                            Rol <span class="text-danger">*</span>
                          </label>
                          <select class="form-select" id="rol" name="rol" required>
                            <option value="">Seleccionar rol</option>
                            <option th:each="rol : ${roles}" th:value="${rol}" th:text="${rol}"
                              th:attr="selected=${user.rol.nombre == rol ? 'selected' : null}"></option>
                          </select>
                          <div class="invalid-feedback">
                            Por favor seleccione un rol.
                          </div>
                        </div>
                        <div class="col-md-6 mb-3">
                          <label class="form-label">Estado</label>
                          <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="activo" th:value="${user.activo}"
                              name="activo" checked>
                            <label class="form-check-label" for="activo">
                              Usuario Activo
                            </label>
                          </div>
                          <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Usuarios inactivos no pueden iniciar sesión
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Información adicional -->
                    <div class="card bg-light mb-4">
                      <div class="card-body">
                        <h6 class="card-title text-muted mb-3">
                          <i class="fas fa-info-circle me-2"></i>Información del Sistema
                        </h6>
                        <div class="row">
                          <div class="col-md-6">
                            <p class="mb-2">
                              <strong>ID:</strong>
                              <span th:text="${user.id}" class="text-muted">-</span>
                            </p>
                            <p class="mb-0">
                              <strong>Fecha de Creación:</strong>
                              <span th:text="${#temporals.format(user.fechaCreacion, 'dd/MM/yyyy HH:mm')}"
                                class="text-muted">-</span>
                            </p>
                          </div>
                          <div class="col-md-6">
                            <p class="mb-2">
                              <strong>Última Modificación:</strong>
                              <span th:text="${#temporals.format(user.fechaModificacion, 'dd/MM/yyyy HH:mm')}"
                                class="text-muted">-</span>
                            </p>
                            <p class="mb-0">
                              <strong>Último Acceso:</strong>
                              <span
                                th:text="${user.ultimoAcceso != null ? #temporals.format(user.ultimoAcceso, 'dd/MM/yyyy HH:mm') : 'Nunca'}"
                                class="text-muted">-</span>
                            </p>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Botones de acción -->
                    <div class="d-flex justify-content-between">
                      <a th:href="@{/admin/users}" class="btn btn-secondary">
                        <i class="fas fa-times me-2"></i>Cancelar
                      </a>
                      <div>
                        <button type="reset" class="btn btn-outline-secondary me-2">
                          <i class="fas fa-undo me-2"></i>Restablecer
                        </button>
                        <button type="submit" class="btn btn-primary">
                          <i class="fas fa-save me-2"></i>Guardar Cambios
                        </button>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Footer -->
  <footer class="page-footer">
    <div class="container-fluid">
      <p class="mb-0">&copy; 2025 Our Application. Todos los derechos reservados.</p>
    </div>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Toggle password visibility
      const togglePassword = document.getElementById('togglePassword');
      const passwordInput = document.getElementById('contraseña');

      if (togglePassword) {
        togglePassword.addEventListener('click', function () {
          const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
          passwordInput.setAttribute('type', type);

          const icon = this.querySelector('i');
          icon.classList.toggle('fa-eye');
          icon.classList.toggle('fa-eye-slash');
        });
      }

      // Validar que las contraseñas coincidan
      const contraseña = document.getElementById('contraseña');
      const confirmarContraseña = document.getElementById('confirmarContraseña');
      const form = document.querySelector('form');

      form.addEventListener('submit', function (event) {
        // Solo validar si se está cambiando la contraseña
        if (contraseña.value !== '') {
          if (contraseña.value !== confirmarContraseña.value) {
            event.preventDefault();
            event.stopPropagation();
            confirmarContraseña.classList.add('is-invalid');
            document.getElementById('passwordMismatch').style.display = 'block';
          } else {
            confirmarContraseña.classList.remove('is-invalid');
            document.getElementById('passwordMismatch').style.display = 'none';
          }
        }

        // Validación de Bootstrap
        if (!form.checkValidity()) {
          event.preventDefault();
          event.stopPropagation();
        }

        form.classList.add('was-validated');
      });

      // Limpiar error cuando se escribe
      confirmarContraseña.addEventListener('input', function () {
        if (this.value === contraseña.value) {
          this.classList.remove('is-invalid');
          document.getElementById('passwordMismatch').style.display = 'none';
        }
      });
    });
  </script>
</body>

</html>
