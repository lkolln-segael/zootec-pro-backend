<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestión de Enfermedades</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" th:href="@{/css/styles.css}">
</head>

<body class="admin-body">
  <div class="admin-layout">
    <!-- Incluir el sidebar -->
    <div th:insert="~{sidebar/sidebar :: sidebar}"></div>

    <!-- Contenido principal -->
    <div class="main-content">
      <div class="container-fluid">
        <!-- Alertas de éxito o error -->
        <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
          <i class="fas fa-check-circle me-2"></i>
          <span th:text="${success}"></span>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
          <i class="fas fa-exclamation-circle me-2"></i>
          <span th:text="${error}"></span>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-4">
          <h1><i class="fas fa-virus me-3"></i>Gestión de Enfermedades</h1>
          <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalTipoEnfermedad">
            <i class="fas fa-plus me-2"></i> Nueva Enfermedad
          </button>
        </div>

        <!-- Tabla de enfermedades -->
        <div class="card shadow-sm">
          <div class="card-header bg-primary text-white">
            <h5 class="card-title mb-0">
              <i class="fas fa-list me-2"></i>Lista de Enfermedades
            </h5>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Animal</th>
                    <th class="text-center">Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  <tr th:each="enfermedad : ${tipoEnfermedades}">
                    <td th:text="${enfermedad.id}">1</td>
                    <td th:text="${enfermedad.nombre}">Tuberculosis</td>
                    <td>
                      <span class="badge bg-secondary" th:text="${enfermedad.tipoAnimales.nombre}">Mamífero</span>
                    </td>
                    <td>
                      <div class="d-flex justify-content-center gap-2">
                        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal"
                          th:attr="data-bs-target='#modalEditarTipoEnfermedad-' + ${enfermedad.id}">
                          <i class="fas fa-edit me-1"></i> Editar
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-enfermedad" th:data-id="${enfermedad.id}">
                          <i class="fas fa-trash me-1"></i> Eliminar
                        </button>
                      </div>
                      <div class="d-flex justify-content-center gap-2">
                        <button class="btn btn-sm btn-outline-warning" data-bs-toggle="modal"
                          th:attr="data-bs-target='#modalSintomas-' + ${enfermedad.id}">
                          <i class="fas fa-biohazard me-1"></i> Sintomas
                        </button>
                        <button class="btn btn-sm btn-outline-info"
                          th:attr="data-bs-target='#modalTratamientos-' + ${enfermedad.id}" data-bs-toggle="modal">
                          <i class="fas fa-book-medical me-1"></i> Tratamientos
                        </button>
                      </div>
                    </td>
                  </tr>
                  <!-- Estado vacío -->
                  <tr th:if="${#lists.isEmpty(tipoEnfermedades)}">
                    <td colspan="4" class="text-center py-5 text-muted">
                      <i class="fas fa-info-circle fa-3x mb-3 d-block"></i>
                      <h5>No hay enfermedades registradas</h5>
                      <p class="mb-0">Comience agregando una nueva enfermedad.</p>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para agregar enfermedad -->
  <div class="modal fade" id="modalTipoEnfermedad" tabindex="-1" aria-labelledby="modalTipoEnfermedadLabel"
    aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="modalTipoEnfermedadLabel">
            <i class="fas fa-plus me-2"></i>Agregar Enfermedad
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form th:action="@{/admin/enfermedades/tipo}" method="post">
          <div class="modal-body">
            <div class="mb-3">
              <label for="nombre" class="form-label">Nombre de la enfermedad</label>
              <input type="text" class="form-control" id="nombre" name="nombre" required
                placeholder="Ej: Sarampión, Tuberculosis, Malaria...">
            </div>
            <div class="mb-3">
              <label for="tipoAnimalId" class="form-label">Animal</label>
              <select class="form-select" id="tipoAnimalId" name="tipoAnimalId" required>
                <option value="" disabled selected>Seleccione el tipo de animal</option>
                <option th:each="animal : ${tipoAnimales}" th:value="${animal.id}" th:text="${animal.nombre}">Mamífero
                </option>
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary">Guardar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modales de edición (generados dinámicamente para cada enfermedad) -->
  <div th:each="enfermedad : ${tipoEnfermedades}">
    <div class="modal fade" th:id="'modalEditarTipoEnfermedad-' + ${enfermedad.id}" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">
              <i class="fas fa-edit me-2"></i>Editar Enfermedad
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <!-- Usar POST con parámetro _method para simular PUT -->
          <form th:action="@{/admin/enfermedades/tipo/} + ${enfermedad.id}" method="post">
            <input type="hidden" name="_method" value="PUT" />
            <div class="modal-body">
              <div class="mb-3">
                <label for="nombre" class="form-label">Nombre de la enfermedad</label>
                <input type="text" class="form-control" id="nombre" name="nombre" required
                  th:value="${enfermedad.nombre}" placeholder="Ej: Sarampión, Tuberculosis, Malaria...">
              </div>
              <div class="mb-3">
                <label for="tipoAnimalId" class="form-label">Animal</label>
                <select class="form-select" id="tipoAnimalId" name="tipoAnimalId" required>
                  <option th:each="animal : ${tipoAnimales}" th:value="${animal.getId()}"
                    th:text="${animal.getNombre()}"
                    th:selected="${animal.getId().toString() == enfermedad.getTipoAnimales().getId().toString()}">
                  </option>
                </select>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-primary">Actualizar</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <div class="modal fade" th:id="'modalSintomas-' + ${enfermedad.id}" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">
              <i class="fas fa-edit me-2"></i>Editar Síntomas de la Enfermedad
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <form class="sintomas-form" th:data-id="${enfermedad.id}">
            <div class="modal-body">
              <div class="mb-3">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <label for="sintomas" class="form-label">Síntomas</label>
                <textarea disabled class="form-control" id="sintomas" name="sintomas" rows="5"
                  th:text="${enfermedad.sintomas}"></textarea>
                <button class="btn btn-primary add-sintoma mt-2" type="button">
                  <i class="fas fa-plus me-1"></i> Agregar Síntoma
                </button>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-primary">Guardar Síntomas</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <div class="modal fade" th:id="'modalTratamientos-' + ${enfermedad.id}" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">
              <i class="fas fa-edit me-2"></i>Editar Tratamientos de la Enfermedad
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <form class="tratamientos-form" th:data-id="${enfermedad.id}">
            <div class="modal-body">
              <div class="mb-3">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <textarea disabled class="form-control" id="tratamientos" name="tratamientos" rows="5"
                  th:text="${enfermedad.tratamientos}"></textarea>
                <label for="tratamientos" class="form-label">Tratamientos</label>
                <button class="btn btn-primary add-tratamiento mt-2" type="button">
                  <i class="fas fa-plus me-1"></i> Agregar Tratamiento
                </button>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-primary">Guardar Tratamientos</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <!-- Modal de confirmación para eliminar -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title">
              <i class="fas fa-exclamation-triangle me-2"></i>Confirmar Eliminación
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>¿Está seguro de que desea eliminar esta enfermedad?</p>
            <p class="fw-bold text-danger">Esta acción no se puede deshacer.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <!-- Formulario para eliminar usando POST con _method DELETE -->
            <form id="deleteForm" method="post" style="display: inline;">
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
              <input type="hidden" name="_method" value="DELETE" />
              <button type="submit" class="btn btn-danger">Eliminar</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/js/admin/enfermedades.js}"></script>
    <!-- Script para manejar los modales -->
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        // Limpiar el formulario cuando se cierre el modal de agregar
        const modal = document.getElementById('modalTipoEnfermedad');
        if (modal) {
          modal.addEventListener('hidden.bs.modal', function () {
            const form = this.querySelector('form');
            if (form) form.reset();
          });
        }

        // Validación del formulario de agregar
        const addForm = document.querySelector('#modalTipoEnfermedad form');
        if (addForm) {
          addForm.addEventListener('submit', function (e) {
            const nombre = this.querySelector('#nombre').value.trim();
            const tipoAnimalId = this.querySelector('#tipoAnimalId').value;

            if (!nombre || !tipoAnimalId) {
              e.preventDefault();
              alert('Por favor, complete todos los campos.');
            }
          });
        }

        // Manejo de eliminación
        const deleteButtons = document.querySelectorAll('.delete-enfermedad');
        const deleteConfirmModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
        const deleteForm = document.getElementById('deleteForm');

        deleteButtons.forEach(button => {
          button.addEventListener('click', function () {
            const enfermedadId = this.getAttribute('data-id');
            // Establecer la acción del formulario con el ID de la enfermedad
            deleteForm.action = '/admin/enfermedades/tipo/' + enfermedadId;
            deleteConfirmModal.show();
          });
        });

        // Limpiar formularios de edición cuando se cierran (opcional, si se desea)
        // En este caso, como los valores se cargan desde el servidor, no es necesario resetear.
      });
    </script>
</body>

</html>
